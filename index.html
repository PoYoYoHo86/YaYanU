// 下の壁アイテム用の状態
let bottomWallActive = false;
let bottomWallTimer = 0;
let itemDrops = [];

function drawBall(ball) {
  ball.trail.unshift({ x: ball.x, y: ball.y });
  if (ball.trail.length > 10) ball.trail.pop();

  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ballRadius, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();
  ctx.closePath();

  ctx.strokeStyle = "rgba(255,255,255,0.5)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i = 0; i < ball.trail.length - 1; i++) {
    const p1 = ball.trail[i];
    const p2 = ball.trail[i + 1];
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
  }
  ctx.stroke();
}

function createItem(x, y) {
  itemDrops.push({ x, y, width: 20, height: 20, dy: 2 });
}

function drawItems() {
  for (let i = itemDrops.length - 1; i >= 0; i--) {
    const item = itemDrops[i];
    item.y += item.dy;
    ctx.fillStyle = "cyan";
    ctx.fillRect(item.x, item.y, item.width, item.height);

    if (
      item.y + item.height > canvas.height - paddleHeight &&
      item.x > paddleX &&
      item.x < paddleX + paddleWidth
    ) {
      bottomWallActive = true;
      bottomWallTimer = 600; // 約10秒 (60FPS想定)
      itemDrops.splice(i, 1);
    } else if (item.y > canvas.height) {
      itemDrops.splice(i, 1);
    }
  }
}

function drawBottomWall() {
  if (bottomWallActive) {
    ctx.fillStyle = "rgba(0, 255, 255, 0.5)";
    ctx.fillRect(0, canvas.height - 5, canvas.width, 5);
    bottomWallTimer--;
    if (bottomWallTimer <= 0) {
      bottomWallActive = false;
    }
  }
}

// collisionDetection 関数内に以下を追加：
// if (Math.random() < 0.1) createItem(ball.x, ball.y);

// draw 関数の中に以下を適切に追加：
// drawItems(); // balls.forEach のあと
// drawBottomWall(); // drawPaddle() のあと

// draw関数中の下部壁との当たり判定：
// else if (ball.y + ball.dy * speedMultiplier > canvas.height - ballRadius) {
//   if (bottomWallActive) {
//     ball.dy = -Math.abs(ball.dy); // 壁で跳ね返る
//   } else if (ball.x > paddleX && ball.x < paddleX + paddleWidth) {
//     ball.dy = -ball.dy;
//   } else {
//     balls = balls.filter(b => b !== ball);
//     if (balls.length === 0) endGame(false);
//   }
// }
